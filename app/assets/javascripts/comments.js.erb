promeni.factory('Comment', ['$resource', function($resource) {
  return $resource('/api/v1/comments/:id', null, {
    'query': { method:'GET', isArray: false },
    'vote': { method: "POST", url: "/vote" },
    'flag': { method: "POST", url: "/flag"}
  });
}]);

promeni.service("commentService", ["Comment", function(Comment) {

  this.query = function(params) {
    return Comment.query(params);
  }

  this.save = function(params) {
    return Comment.save(params);
  }

  this.delete = function(params) {
    return Comment.delete(params);
  }

  this.flag = function(params) {
    return Comment.flag(params);
  }

  this.vote = function(params) {
    return Comment.vote(params);
  }

}]);

promeni.controller('CommentCreateController', ["$scope", "commentService", function($scope, commentService) {

  $scope.logged_in = $("#logged_in").length !== 0 ? true : false;

  $scope.showWarning = function() {
    $("#warning-box").slideDown();
    $("#comment-box").attr("rows", 8);
  }

  $scope.newComment = { content: "" };

  $scope.createNewComment = function() {
    var params = {
      commentable_id: $scope.proposal.id,
      commentable_type: "proposal",
      content: $scope.newComment.content
    };
    commentService.save(params).$promise.then(function(comment) {
      $scope.comments.unshift(comment);

      $("#warning-box").slideUp();
      $("#comment-box").attr("rows", 3);
      $scope.newComment = { content: "" };
    });
  }

}]);

promeni.controller('CommentIndexController', ["$scope", "commentService", function($scope, commentService) {
  var getCommentsData = function() {
    var params = angular.copy($scope.params);
    params.commetable_type = "proposal";

    commentService.query(params).$promise.then(function(data) {
      $scope.comments = data.comments;
      $scope.commentsCount = data.comments_count;
    });
  }

  $scope.params = {
    order: "relevance",
    page: 1
  }

  $scope.$watchCollection("[params.order, params.page]", function(newValue, oldValue) {
    if (newValue === oldValue) return;
    getCommentsData();
  });

  $scope.closeAlert = function(comment) {
    comment.alerts = [];
  }

  $scope.flag = function(comment, reason) {
    commentService.flag(comment, reason).$promise.then(function(data) {
      comment.alerts = [{
        type: "success", msg: "Вие докладвахте този коментар. Благодарим ви."
      }];
    });
  }

  $scope.destroyComment = function(comment) {
    commentService.delete({ id: comment.id }).$promise.then(function(data) {
      getCommentsData();
    });
  }

  getCommentsData();

}]);


